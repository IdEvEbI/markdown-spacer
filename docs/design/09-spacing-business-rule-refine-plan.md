---
**文档标题**：中英文空格处理业务规则完善开发计划
**文档版本**：v1.1
**创建时间**：2025-07-23
**更新时间**：2025-07-24
**维护人员**：刘凡 & 小克
**文档状态**：开发中
---

# Spacing 业务规则重构方案（分层处理）

## 1. 现有问题总结

- 现有 _format_line 试图用一套正则反复处理整行内容，导致结构标记（如 #、-、*、|、>、`、[ ]、[x]、~ 等）和正文内容混杂，难以维护。
- 单测和实际 Markdown 文件修复效果不一致，容易出现"修复结构破坏"或"内容误伤"问题。
- 代码反复修补，难以扩展和保证长期可维护性。

## 2. 新的分层处理思路

### 2.1 结构与内容分离

- 先识别并分离 Markdown 行的结构标记（如标题、列表、引用、表格、代码块、任务列表等）。
- 只对"内容块"做空格修复和正向添加空格，结构部分保持原样。

### 2.2 专门的内容修复函数

- 只处理内容块，内部严格两步：
  1. 逆向修复（如合并多空格、去除多余空格、修复历史遗留格式）
  2. 正向空格处理（如中英、数字、符号间保留一个空格）
- 不再在 _format_line 里反复处理整行。

### 2.3 _format_line 只做分发和拼接

- 先识别行类型（标题、列表、引用、表格、代码块等）。
- 拆解出内容块（如表格单元格、行内加粗、斜体、高亮、链接、图片等）。
- 对每个内容块调用内容修复函数，最后拼接回完整行。

### 2.4 性能与可维护性

- 分层处理方式便于维护和扩展，性能优于"全行反复正则"。
- 单测和实际效果高度一致。

## 3. 业务规则梳理（需要确认）

### 3.1 空格处理流程

markdown-spacer 的空格处理采用三步流程：

1. **第一步：基本空格处理** - 在中英文、数字、符号之间添加空格
2. **第二步：多空格合并** - 将多个连续空格合并为单个空格
3. **第三步：业务规则修复** - 根据业务规则删除不应该存在的空格

### 3.2 第一步：基本空格处理规则

| 规则类型 | 正则表达式 | 处理方式 | 示例 |
| -------- | ---------- | -------- | ---- |
| 中英文间 | `([一-龯])([a-zA-Z])` | 添加空格 | `中文English` → `中文 English` |
| 英中文间 | `([a-zA-Z])([一-龯])` | 添加空格 | `English中文` → `English 中文` |
| 中数字间 | `([一-龯])(\d)` | 添加空格 | `中文123` → `中文 123` |
| 数字中间 | `(\d)([一-龯])` | 添加空格 | `123中文` → `123 中文` |
| 英数字间 | `([a-zA-Z])(\d)` | 添加空格 | `English123` → `English 123` |
| 数字英间 | `(\d)([a-zA-Z])` | 添加空格 | `123English` → `123 English` |
| 数学符号 | `([\u4e00-\u9fa5a-zA-Z0-9])([+\-/*=<>])([\u4e00-\u9fa5a-zA-Z0-9])` | 添加空格 | `A+B` → `A + B`，`张三-李四` → `张三 - 李四` |
| 英文标点后 | `([,\.!?;:])([A-Za-z\u4e00-\u9fa5])` | 添加空格 | `Hello,world` → `Hello, world` |
| 英文右括号后 | `(\))([A-Za-z\u4e00-\u9fa5])` | 添加空格 | `(test)world` → `(test) world` |
| 中文斜杠分隔 | `([\u4e00-\u9fa5])\s*/\s*([\u4e00-\u9fa5])` | 添加空格 | `文本/JSON` → `文本 / JSON` |
| 编号与中文 | `([\u4e00-\u9fa5])(\d+)` | 添加空格 | `优先级1` → `优先级 1` |

### 3.3 第二步：多空格合并规则

| 规则类型 | 正则表达式 | 处理方式 | 示例 |
| -------- | ---------- | -------- | ---- |
| 合并多空格 | `+` | 合并为单空格 | `中文   English` → `中文 English` |

### 3.4 第三步：业务规则修复（删除多余空格）

| 规则类型 | 正则表达式 | 处理方式 | 示例 |
| -------- | ---------- | -------- | ---- |
| 版本号修复 | `v (\d+(?:\.\d+)+)` | 删除空格 | `v 1.2.3` → `v1.2.3` |
| 数字与单位修复 | `(\d+) (MB&#124;GB&#124;KB&#124;TB&#124;B&#124;℃&#124;°C&#124;°F&#124;%&#124;km&#124;cm&#124;mm&#124;m&#124;kg&#124;g&#124;mg&#124;s&#124;ms&#124;h&#124;d&#124;px&#124;em&#124;rem&#124;pt&#124;%)` | 删除空格 | `10 MB` → `10MB` |
| 技术缩写修复 | `([A-Z]{2,}) - ([A-Z0-9]+)` | 删除空格 | `UTF - 8` → `UTF-8` |
| 英文连字符修复 | `([a-zA-Z0-9]+) - ([a-zA-Z0-9]+)` | 删除空格 | `Todo - List` → `Todo-List` |
| 文件扩展名修复 | `(\w+) \. ([a-zA-Z0-9]+)` | 删除空格 | `requirements . txt` → `requirements.txt` |
| 工具名修复 | `(flake) (8)` | 删除空格 | `flake 8` → `flake8` |
| 路径修复 | `(?<![\u4e00-\u9fa5])\s*/\s*(?![\u4e00-\u9fa5])` | 删除空格 | `src / core / formatter. py` → `src/core/formatter.py` |
| 反引号路径保护 | `` `([^`]+)` `` | 不处理 | `` `src/core/formatter.py` `` → `` `src/core/formatter.py` `` |
| 比较符号修复 | `(>=&#124;<=&#124;!=&#124;==&#124;>&#124;<&#124;＞&#124;＜&#124;≥&#124;≤&#124;＝&#124;≠)\s*([0-9])` | 添加空格 | `>=100GB` → `>= 100GB` |
| 日期格式修复 | `(\d{4}) 年 (\d{1,2}) 月 (\d{1,2}) 日` | 删除空格 | `2025 年 7 月 24 日` → `2025年7月24日` |
| 反引号内容保护 | `` `([^`]+)` `` | 不处理 | `` `src/core/formatter.py` `` → `` `src/core/formatter.py` `` |
| 数字+单位+加号修复 | `(\d+)(MB&#124;GB&#124;KB&#124;TB&#124;B)\s*\+` | 删除空格 | `4 GB +` → `4GB+` |
| 英文连字符保护 | `([a-zA-Z]+) - ([a-zA-Z]+)` | 删除空格 | `Todo - List` → `Todo-List` |
| 文件名格式保护 | `([\w\-]+\.(txt&#124;py&#124;toml&#124;yaml&#124;yml&#124;json&#124;md&#124;markdown))` | 不处理 | `requirements.txt` → `requirements.txt` |

### 3.5 特殊内容保护

- **代码块**：以 ``` 包裹的多行代码块
- **行内代码**：以 ` 包裹的内容
- **链接**：`[text](url)` 格式
- **图片**：`![alt](url)` 格式
- **HTML 标签**：`<tag>` 内容
- **数学公式**：`$...$` 或 `$$...$$` 标记的内容

### 3.6 中文双引号加粗（可选）

- **规则**：将"..."内内容加粗为 **...**
- **处理**：加粗内容前后添加适当空格
- **嵌套处理**：如果遇到中文双引号嵌套情况，例如"这是"重点"内容"，不做任何特殊处理
- **示例**：世界"你好"啊 → 世界 **你好** 啊
- **嵌套示例**："这是"重点"内容" → "这是"重点"内容"（不做处理）

## 4. 开发 TODO-LIST

### Phase 1: 测试用例重构 ✅

- [x] 阅读需求文档和技术设计文档
- [x] 梳理业务规则（本节完成）
- [ ] **TODO: 重新设计测试用例结构**
- [ ] **TODO: 编写基本空格处理测试**
- [ ] **TODO: 编写多空格合并测试**
- [ ] **TODO: 编写业务规则修复测试**
- [ ] **TODO: 编写特殊内容保护测试**
- [ ] **TODO: 编写中文双引号加粗测试**

### Phase 2: 核心架构重构（保持接口兼容）

- [ ] **TODO: 保持 MarkdownFormatter 类接口不变**
- [ ] **TODO: 重构内部实现，采用分层处理方式**
- [ ] **TODO: 实现行类型识别函数（内部使用）**
- [ ] **TODO: 实现内容块提取函数（内部使用）**
- [ ] **TODO: 重构 content_spacing_fix 函数（保持方法名不变）**
- [ ] **TODO: 重构 _format_line 函数（保持方法名不变）**
- [ ] **TODO: 确保 format_content 方法接口完全兼容**
- [ ] **TODO: 验证所有现有调用点正常工作**

### Phase 3: 业务规则实现

- [ ] **TODO: 实现基本空格处理规则**
- [ ] **TODO: 实现多空格合并规则**
- [ ] **TODO: 实现业务规则修复**
- [ ] **TODO: 实现特殊内容保护**
- [ ] **TODO: 实现中文双引号加粗功能**

### Phase 4: 测试与优化

- [ ] **TODO: 运行所有测试用例**
- [ ] **TODO: 修复失败的测试**
- [ ] **TODO: 性能优化**
- [ ] **TODO: 代码质量检查**

### Phase 5: 文档更新

- [ ] **TODO: 更新技术设计文档**
- [ ] **TODO: 更新需求文档**
- [ ] **TODO: 更新测试文档**

## 5. 开发优先级

1. **最高优先级**：保持接口兼容性，确保系统正常运行
2. **高优先级**：基本空格处理规则、多空格合并规则、业务规则修复
3. **中优先级**：特殊内容保护、中文双引号加粗
4. **低优先级**：性能优化、文档更新

## 6. 风险评估

- **接口兼容风险**：重构过程中可能破坏现有接口，导致系统无法使用
- **技术风险**：正则表达式复杂度可能影响性能
- **业务风险**：规则冲突可能导致意外结果
- **测试风险**：测试用例覆盖不全面

### 风险缓解策略

- **接口兼容性**：严格保持 MarkdownFormatter 类的公共接口不变
- **渐进式重构**：先重构内部实现，再逐步优化
- **充分测试**：每个阶段都要验证接口兼容性
- **回滚准备**：保留原有实现作为备份

## 7. 成功标准

- [ ] 所有测试用例通过
- [ ] 代码覆盖率 > 90%
- [ ] 性能无明显下降
- [ ] 代码质量检查通过
