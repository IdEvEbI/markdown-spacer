---
**文档标题**：中英文空格处理业务规则完善开发计划
**文档版本**：v1.1
**创建时间**：2025-07-23
**更新时间**：2025-07-24
**维护人员**：刘凡 & 小克
**文档状态**：开发中
---

# Spacing 业务规则重构方案（分层处理）

## 1. 现有问题总结

- 现有 _format_line 试图用一套正则反复处理整行内容，导致结构标记（如 #、-、*、|、>、`、[ ]、[x]、~ 等）和正文内容混杂，难以维护。
- 单测和实际 Markdown 文件修复效果不一致，容易出现"修复结构破坏"或"内容误伤"问题。
- 代码反复修补，难以扩展和保证长期可维护性。

## 2. 新的分层处理思路

### 2.1 结构与内容分离

- 先识别并分离 Markdown 行的结构标记（如标题、列表、引用、表格、代码块、任务列表等）。
- 只对"内容块"做空格修复和正向添加空格，结构部分保持原样。

### 2.2 专门的内容修复函数

- 只处理内容块，内部严格两步：
  1. 逆向修复（如合并多空格、去除多余空格、修复历史遗留格式）
  2. 正向空格处理（如中英、数字、符号间保留一个空格）
- 不再在 _format_line 里反复处理整行。

### 2.3 _format_line 只做分发和拼接

- 先识别行类型（标题、列表、引用、表格、代码块等）。
- 拆解出内容块（如表格单元格、行内加粗、斜体、高亮、链接、图片等）。
- 对每个内容块调用内容修复函数，最后拼接回完整行。

### 2.4 性能与可维护性

- 分层处理方式便于维护和扩展，性能优于"全行反复正则"。
- 单测和实际效果高度一致。

## 3. 业务规则梳理（需要确认）

### 3.1 空格处理流程

markdown-spacer 的空格处理采用三步流程：

1. **第一步：基本空格处理** - 在中英文、数字、符号之间添加空格
2. **第二步：多空格合并** - 将多个连续空格合并为单个空格
3. **第三步：业务规则修复** - 根据业务规则删除不应该存在的空格

### 3.2 第一步：基本空格处理规则

| 规则类型 | 正则表达式 | 处理方式 | 示例 |
| -------- | ---------- | -------- | ---- |
| 中英文间 | `([一-龯])([a-zA-Z])` | 添加空格 | `中文English` → `中文 English` |
| 英中文间 | `([a-zA-Z])([一-龯])` | 添加空格 | `English中文` → `English 中文` |
| 中数字间 | `([一-龯])(\d)` | 添加空格 | `中文123` → `中文 123` |
| 数字中间 | `(\d)([一-龯])` | 添加空格 | `123中文` → `123 中文` |
| 英数字间 | `([a-zA-Z])(\d)` | 添加空格 | `English123` → `English 123` |
| 数字英间 | `(\d)([a-zA-Z])` | 添加空格 | `123English` → `123 English` |
| 数学符号 | `([\u4e00-\u9fa5a-zA-Z0-9])([+\-/*=<>])([\u4e00-\u9fa5a-zA-Z0-9])` | 添加空格 | `A+B` → `A + B`，`张三-李四` → `张三 - 李四` |
| 英文标点后 | `([,\.!?;:])([A-Za-z\u4e00-\u9fa5])` | 添加空格 | `Hello,world` → `Hello, world` |
| 英文右括号后 | `(\))([A-Za-z\u4e00-\u9fa5])` | 添加空格 | `(test)world` → `(test) world` |
| 中文斜杠分隔 | `([\u4e00-\u9fa5])\s*/\s*([\u4e00-\u9fa5])` | 添加空格 | `文本/JSON` → `文本 / JSON` |
| 编号与中文 | `([\u4e00-\u9fa5])(\d+)` | 添加空格 | `优先级1` → `优先级 1` |

### 3.3 第二步：多空格合并规则

| 规则类型 | 正则表达式 | 处理方式 | 示例 |
| -------- | ---------- | -------- | ---- |
| 合并多空格 | `+` | 合并为单空格 | `中文   English` → `中文 English` |

### 3.4 第三步：业务规则修复（删除多余空格）

> 备注：当前路径修复相关正则（如 src/core/formatter. py → src/core/formatter.py）暂未完全覆盖所有复杂场景，后续会持续完善。

| 规则类型 | 正则表达式 | 处理方式 | 示例 |
| -------- | ---------- | -------- | ---- |
| 版本号修复 | `v (\d+(?:\.\d+)+)` | 删除空格 | `v 1.2.3` → `v1.2.3` |
| 数字与单位修复 | `(\d+) (MB&#124;GB&#124;KB&#124;TB&#124;B&#124;℃&#124;°C&#124;°F&#124;%&#124;km&#124;cm&#124;mm&#124;m&#124;kg&#124;g&#124;mg&#124;s&#124;ms&#124;h&#124;d&#124;px&#124;em&#124;rem&#124;pt&#124;%)` | 删除空格 | `10 MB` → `10MB` |
| 技术缩写修复 | `([A-Z]{2,}) - ([A-Z0-9]+)` | 删除空格 | `UTF - 8` → `UTF-8` |
| 英文连字符修复 | `([a-zA-Z0-9]+) - ([a-zA-Z0-9]+)` | 删除空格 | `Todo - List` → `Todo-List` |
| 文件扩展名修复 | `(\w+) \. ([a-zA-Z0-9]+)` | 删除空格 | `requirements . txt` → `requirements.txt` |
| 工具名修复 | `(flake) (8)` | 删除空格 | `flake 8` → `flake8` |
| 路径修复 | `(?<![\u4e00-\u9fa5])\s*/\s*(?![\u4e00-\u9fa5])` | 删除空格 | `src / core / formatter. py` → `src/core/formatter.py` |
| 反引号路径保护 | `` `([^`]+)` `` | 不处理 | `` `src/core/formatter.py` `` → `` `src/core/formatter.py` `` |
| 比较符号修复 | `(>=&#124;<=&#124;!=&#124;==&#124;>&#124;<&#124;＞&#124;＜&#124;≥&#124;≤&#124;＝&#124;≠)\s*([0-9])` | 添加空格 | `>=100GB` → `>= 100GB` |
| 日期格式修复 | `(\d{4}) 年 (\d{1,2}) 月 (\d{1,2}) 日` | 删除空格 | `2025 年 7 月 24 日` → `2025年7月24日` |
| 反引号内容保护 | `` `([^`]+)` `` | 不处理 | `` `src/core/formatter.py` `` → `` `src/core/formatter.py` `` |
| 数字+单位+加号修复 | `(\d+)(MB&#124;GB&#124;KB&#124;TB&#124;B)\s*\+` | 删除空格 | `4 GB +` → `4GB+` |
| 英文连字符保护 | `([a-zA-Z]+) - ([a-zA-Z]+)` | 删除空格 | `Todo - List` → `Todo-List` |
| 文件名格式保护 | `([\w\-]+\.(txt&#124;py&#124;toml&#124;yaml&#124;yml&#124;json&#124;md&#124;markdown))` | 不处理 | `requirements.txt` → `requirements.txt` |

### 3.5 特殊内容保护

- **代码块**：以 ``` 包裹的多行代码块
- **行内代码**：以 ` 包裹的内容
- **链接**：`[text](url)` 格式
- **图片**：`![alt](url)` 格式
- **HTML 标签**：`<tag>` 内容
- **数学公式**：`$...$` 或 `$$...$$` 标记的内容

### 3.6 中文双引号加粗（可选）

- **规则**：将"..."内内容加粗为 **...**
- **处理**：加粗内容前后添加适当空格
- **嵌套处理**：如果遇到中文双引号嵌套情况，例如"这是"重点"内容"，不做任何特殊处理
- **示例**：世界"你好"啊 → 世界 **你好** 啊
- **嵌套示例**："这是"重点"内容" → "这是"重点"内容"（不做处理）

## 4. 开发 TODO-LIST

### Phase 1: 测试用例重构 ✅

- [x] 阅读需求文档和技术设计文档
- [x] 梳理业务规则（本节完成）
- [x] **TODO: 重新设计测试用例结构**
- [ ] **TODO: 编写基本空格处理测试**
- [ ] **TODO: 编写多空格合并测试**
- [ ] **TODO: 编写业务规则修复测试**
- [ ] **TODO: 编写特殊内容保护测试**
- [ ] **TODO: 编写中文双引号加粗测试**

### Phase 2: 核心架构重构（保持接口兼容）

- [ ] **TODO: 保持 MarkdownFormatter 类接口不变**
- [ ] **TODO: 重构内部实现，采用分层处理方式**
- [ ] **TODO: 实现行类型识别函数（内部使用）**
- [ ] **TODO: 实现内容块提取函数（内部使用）**
- [ ] **TODO: 重构 content_spacing_fix 函数（保持方法名不变）**
- [ ] **TODO: 重构 _format_line 函数（保持方法名不变）**
- [ ] **TODO: 确保 format_content 方法接口完全兼容**
- [ ] **TODO: 验证所有现有调用点正常工作**

### Phase 3: 业务规则实现

- [ ] **TODO: 实现基本空格处理规则**
- [ ] **TODO: 实现多空格合并规则**
- [ ] **TODO: 实现业务规则修复**
- [ ] **TODO: 实现特殊内容保护**
- [ ] **TODO: 实现中文双引号加粗功能**

### Phase 4: 测试与优化

- [ ] **TODO: 运行所有测试用例**
- [ ] **TODO: 修复失败的测试**
- [ ] **TODO: 性能优化**
- [ ] **TODO: 代码质量检查**

### Phase 5: 文档更新

- [ ] **TODO: 更新技术设计文档**
- [ ] **TODO: 更新需求文档**
- [ ] **TODO: 更新测试文档**

## 5. 开发优先级

1. **最高优先级**：保持接口兼容性，确保系统正常运行
2. **高优先级**：基本空格处理规则、多空格合并规则、业务规则修复
3. **中优先级**：特殊内容保护、中文双引号加粗
4. **低优先级**：性能优化、文档更新

## 6. 渐进式开发计划（企业最佳实践）

### Sprint 1: 基础架构搭建

**目标**: 建立分层处理框架，实现基础行类型识别
**提交粒度**: 每个功能点独立提交

1. **提交 1**: 实现行类型识别方法
   - `_is_title_line()`
   - `_is_list_line()`
   - `_is_quote_line()`
   - `_is_table_line()`
   - `_is_code_block_line()`

2. **提交 2**: 实现内容块提取方法
   - `_extract_title_content()`
   - `_extract_list_content()`
   - `_extract_quote_content()`
   - `_extract_table_cells()`

3. **提交 3**: 重构 `_format_line()` 方法
   - 实现结构标记保护
   - 实现内容块分发处理

### Sprint 2: 基本空格处理

**目标**: 实现核心空格处理规则
**提交粒度**: 每个规则类型独立提交

1. **提交 4**: 中英文空格处理
   - 中英文间空格
   - 英中文间空格

2. **提交 5**: 数字空格处理
   - 中数字间空格
   - 数字中间空格
   - 英数字间空格
   - 数字英间空格

3. **提交 6**: 符号空格处理
   - 数学符号空格
   - 英文标点后空格
   - 英文右括号后空格

### Sprint 3: 多空格合并

**目标**: 实现空格合并和清理

1. **提交 7**: 多空格合并规则
   - 连续空格合并
   - 前后空格处理

### Sprint 4: 业务规则修复

**目标**: 实现特定业务场景的空格修复
**提交粒度**: 按业务场景分组提交

1. **提交 8**: 技术术语修复
   - 版本号修复
   - 技术缩写修复
   - 工具名修复

2. **提交 9**: 文件路径修复
   - 文件扩展名修复
   - 路径修复
   - 文件名格式保护

3. **提交 10**: 单位和比较符号修复
    - 数字与单位修复
    - 比较符号修复
    - 数字+单位+加号修复

4. **提交 11**: 日期和特殊格式修复
    - 日期格式修复
    - 中文斜杠分隔
    - 编号与中文

### Sprint 5: 特殊内容保护

**目标**: 实现内容保护机制

1. **提交 12**: 代码内容保护
    - 代码块保护
    - 行内代码保护

2. **提交 13**: 其他内容保护
    - 链接和图片保护
    - 数学公式保护
    - HTML标签保护

### Sprint 6: 高级功能

**目标**: 实现可选的高级功能

1. **提交 14**: 中文双引号加粗
    - 基本加粗功能
    - 嵌套引号处理

### Sprint 7: 测试完善

**目标**: 完善测试覆盖

1. **提交 15**: 边界情况测试
    - 空内容处理
    - 复杂文档处理

## 7. 提交规范

### 提交信息格式

```text
type(scope): 简短描述

详细描述（可选）

- 功能点1
- 功能点2
- 测试用例
```

### 提交类型

- `feat`: 新功能
- `fix`: 修复bug
- `refactor`: 重构
- `test`: 测试相关
- `docs`: 文档更新

### 示例提交信息

```text
feat(formatter): 实现行类型识别功能

- 添加 _is_title_line() 方法
- 添加 _is_list_line() 方法
- 添加 _is_quote_line() 方法
- 添加 _is_table_line() 方法
- 添加 _is_code_block_line() 方法
- 添加对应的单元测试

Closes #123
```

## 8. 质量保证

### 每个提交前检查

- [ ] 代码通过所有测试
- [ ] 代码质量检查通过（flake8, mypy）
- [ ] 新功能有对应测试用例
- [ ] 提交信息符合规范

### 持续集成

- 每次提交触发自动化测试
- 代码覆盖率不低于90%
- 性能无明显下降

## 9. 风险评估

- **接口兼容风险**：重构过程中可能破坏现有接口，导致系统无法使用
- **技术风险**：正则表达式复杂度可能影响性能
- **业务风险**：规则冲突可能导致意外结果
- **测试风险**：测试用例覆盖不全面
- **路径修复风险**：路径修复正则暂未完全覆盖所有场景，部分边界情况（如 src/core/formatter. py）后续会持续完善

### 风险缓解策略

- **接口兼容性**：严格保持 MarkdownFormatter 类的公共接口不变
- **渐进式重构**：先重构内部实现，再逐步优化
- **充分测试**：每个阶段都要验证接口兼容性
- **回滚准备**：保留原有实现作为备份

## 10. 成功标准

- [ ] 所有测试用例通过
- [ ] 代码覆盖率 > 90%
- [ ] 性能无明显下降
- [ ] 代码质量检查通过
- [ ] 每个功能点都有独立提交
- [ ] 提交历史清晰可追溯

## 11. 开发工具

### 调试工具

为了支持渐进式开发和快速验证，项目提供了专门的调试工具：

#### 文件位置

```text
scripts/debug/debug_formatter.py
```

#### 功能特性

- ✅ 基础空格处理测试
- ✅ 数学符号处理测试  
- ✅ 标点符号处理测试
- ✅ 特殊内容保护测试
- ✅ 混合内容测试
- ✅ 正则表达式模式测试
- ✅ HTML标签保护测试

#### 使用方法

```bash
# 在项目根目录下运行
python scripts/debug/debug_formatter.py
```

#### 开发优势

1. **快速验证** - 无需运行完整测试套件
2. **详细输出** - 清晰显示期望值和实际值
3. **模块化** - 可以单独测试特定功能
4. **开发友好** - 便于快速迭代和调试

#### 使用建议

- 在开发新功能时，先使用调试工具验证
- 调试工具通过后，再运行完整测试套件
- 可以修改调试工具中的测试用例来验证特定场景

## 12. 开发约定

### 12.1 身份确认

- **开发前**：明确当前身份（如 Python 高级开发工程师小克）
- **职责明确**：确认当前任务和开发范围
- **协作模式**：与刘凡的协作约定和确认机制

### 12.2 核心文件

- **核心代码**：`src/core/formatter.py` - 主要业务逻辑实现
- **测试代码**：`tests/test_formatter.py` - 单元测试用例
- **调试工具**：`scripts/debug/debug_formatter.py` - 快速调试验证
- **设计文档**：`docs/design/09-spacing-business-rule-refine-plan.md` - 业务规则和开发计划

### 12.3 开发策略

- **小步迭代**：每个业务规则独立开发，完成后立即提交
- **测试驱动**：先阅读测试用例，与业务规则核对，再开始开发
- **渐进式开发**：避免大规模重构，保持接口兼容性
- **提交粒度**：每个业务规则开发完成后提交一次

### 12.4 调试策略

- **优先使用调试工具**：用例没跑通时，优先使用 `scripts/debug/debug_formatter.py`
- **增加调试输出**：在 `formatter.py` 的 `content_spacing_fix` 函数中增加 `print(f"[DEBUG]` 语句
- **定点修复**：通过调试输出捕捉具体哪个正则没有生效，避免"猜测"调试
- **提高效率**：有效捕捉问题，定点修复，避免误伤其他功能
- **统一清理**：所有业务规则开发完毕后，再统一删除所有调试 print 语句

### 12.5 环境准备

- **虚拟环境激活**：`source venv/bin/activate`
- **依赖检查**：确保所有开发依赖已安装
- **代码质量工具**：确保 flake8、black、mypy 等工具可用

### 12.6 确认机制

- **每步确认**：每做完一步都需要确认后，再继续
- **及时沟通**：遇到问题及时沟通对齐，避免方向偏差
- **质量保证**：每个提交前确保代码质量和测试通过

### 12.7 开发流程

```bash
# 1. 激活虚拟环境
source venv/bin/activate

# 2. 阅读测试用例，核对业务规则
# 查看 tests/test_formatter.py 中的相关测试用例
# 核对 docs/design/09-spacing-business-rule-refine-plan.md 中的业务规则

# 3. 小步开发，使用调试工具验证
python scripts/debug/debug_formatter.py

# 4. 开发完成立即提交
git add src/core/formatter.py
git commit -m "feat(formatter): 实现XXX业务规则"

# 5. 确认后再继续下一步
```

### 12.8 调试代码示例

```python
# 在 content_spacing_fix 函数中添加调试输出
def content_spacing_fix(self, text: str) -> str:
    print(f"[DEBUG] 输入文本: {text}")
    
    # 应用正则规则
    for rule_name, pattern in self.patterns.items():
        if pattern.search(text):
            print(f"[DEBUG] 规则 {rule_name} 匹配成功")
            text = pattern.sub(self.replacements[rule_name], text)
            print(f"[DEBUG] 应用规则后: {text}")
    
    return text
```

### 12.9 版本历史

| 版本 | 日期 | 变更内容 | 负责人 |
| ---- | ---- | -------- | ------ |
| v1.1 | 2025-07-24 | 添加开发约定章节，明确开发流程和调试策略 | 刘凡 & 小克 |
